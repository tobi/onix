#!/usr/bin/env bash
# Lint: scan overlays and nix files for leaked secrets.

set -euo pipefail

root="$(cd "$(dirname "$0")/../.." && pwd)"

if command -v gitleaks &>/dev/null; then
  scanner="gitleaks"
elif command -v nix-shell &>/dev/null; then
  scanner="nix-shell -p gitleaks --run gitleaks"
else
  echo "secrets: gitleaks not found, skipping"
  exit 2
fi

findings=0
for dir in "$root/overlays" "$root/nix" "$root/packagesets"; do
  [ -d "$dir" ] || continue
  if ! $scanner detect --source "$dir" --no-git 2>/dev/null; then
    findings=$((findings + 1))
  fi
done

if [ "$findings" -eq 0 ]; then
  echo "secrets: OK (no findings)"
else
  echo "secrets: $findings directories with findings"
  exit 1
fi
