#!/usr/bin/env bash
# Lint: verify all nix files parse without errors.

set -euo pipefail

root="$(cd "$(dirname "$0")/../.." && pwd)"
errors=0
checked=0

# Per-gem version files
for f in "$root/nix/ruby/"*.nix; do
  [ -f "$f" ] || continue
  if ! nix-instantiate --parse "$f" > /dev/null 2>&1; then
    echo "FAIL: $f does not parse"
    nix-instantiate --parse "$f" 2>&1 | head -5
    errors=$((errors + 1))
  fi
  checked=$((checked + 1))
done

# Project nix files
for f in "$root/nix/"*.nix; do
  [ -f "$f" ] || continue
  if ! nix-instantiate --parse "$f" > /dev/null 2>&1; then
    echo "FAIL: $f does not parse"
    nix-instantiate --parse "$f" 2>&1 | head -5
    errors=$((errors + 1))
  fi
  checked=$((checked + 1))
done

# Overlay files
for f in "$root/overlays/"*.nix; do
  [ -f "$f" ] || continue
  if ! nix-instantiate --parse "$f" > /dev/null 2>&1; then
    echo "FAIL: $f does not parse"
    nix-instantiate --parse "$f" 2>&1 | head -5
    errors=$((errors + 1))
  fi
  checked=$((checked + 1))
done

echo "nix-eval: $checked checked, $errors errors"
[ "$errors" -eq 0 ]
