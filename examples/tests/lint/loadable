#!/usr/bin/env ruby
# frozen_string_literal: true

# Lint: try to load a sample of gems in the bundle path.

require "open3"

project = ARGV[0] || "fizzy"

# Build the bundle path
out, status = Open3.capture2e("nix-build", "--no-out-link", "-E", <<~NIX)
  let pkgs = import <nixpkgs> {};
      ruby = pkgs.ruby_3_4;
      resolve = import ./nix/modules/resolve.nix; gems = resolve { inherit pkgs ruby; gemset = import ./nix/app/#{project}.nix; };
  in pkgs.symlinkJoin { name = "bundle"; paths = builtins.attrValues gems; }
NIX
abort "Failed to build bundle-path" unless status.success?
bundle = out.strip.lines.last.strip

nix_ruby_out, _ = Open3.capture2("nix-build", "<nixpkgs>", "-A", "ruby_3_4", "--no-out-link")
nix_ruby = File.join(nix_ruby_out.strip, "bin", "ruby")

gem_dir = Dir.glob("#{bundle}/ruby/*/gems").first

# Test a sample of common gems
test_gems = %w[rack json builder erubi zeitwerk nokogiri psych]
ok = 0
fail_count = 0

test_gems.each do |name|
  matches = Dir.glob("#{gem_dir}/#{name}-*")
  next if matches.empty?

  out, status = Open3.capture2e(
    { "GEM_PATH" => File.dirname(gem_dir), "GEM_HOME" => File.dirname(gem_dir) },
    nix_ruby, "-e", "require '#{name}'"
  )
  if status.success?
    ok += 1
  else
    puts "FAIL: #{name}: #{out.lines.first&.strip}"
    fail_count += 1
  end
end

puts "loadable: #{ok} OK, #{fail_count} failed out of #{ok + fail_count} tested"
exit 1 if fail_count > 0
