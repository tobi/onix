#!/usr/bin/env bash
# Lint: verify every buildable gem in a packageset has a nix/ruby/<name>.nix file.

set -euo pipefail

root="$(cd "$(dirname "$0")/../.." && pwd)"
project="${1:-}"

if [ -z "$project" ]; then
  # Check all packagesets
  packagesets=("$root/packagesets/"*.jsonl)
else
  packagesets=("$root/packagesets/$project.jsonl")
fi

errors=0
checked=0

for pset in "${packagesets[@]}"; do
  [ -f "$pset" ] || continue
  name=$(basename "$pset" .jsonl)

  # Extract gem names from JSONL (skip meta line, skip stdlib/path sources)
  while IFS= read -r line; do
    gem_name=$(echo "$line" | ruby -rjson -e '
      j = JSON.parse(STDIN.read)
      next if j["_meta"]
      next if j["source"] == "stdlib" || j["source"] == "path"
      puts j["name"]
    ' 2>/dev/null) || continue
    [ -z "$gem_name" ] && continue

    nix_file="$root/nix/ruby/$gem_name.nix"
    if [ ! -f "$nix_file" ]; then
      echo "MISSING: $name: $gem_name has no nix/ruby/$gem_name.nix"
      errors=$((errors + 1))
    fi
    checked=$((checked + 1))
  done < "$pset"
done

if [ "$errors" -eq 0 ]; then
  echo "dep-completeness: OK ($checked gems checked)"
else
  echo "dep-completeness: $errors missing out of $checked"
  exit 1
fi
