#!/usr/bin/env ruby
# frozen_string_literal: true

# Lint: verify dependency completeness â€” every dep in Gemfile.lock
# has a matching derivation in the nix directory.

require "bundler"

project  = ARGV[0] || "fizzy"
lockfile = ARGV[1]
nix_dir  = "nix"

unless lockfile
  # Try to find Gemfile.lock in common locations
  candidates = [
    "../#{project}/Gemfile.lock",
    "../ruby-tests/#{project}/Gemfile.lock",
  ]
  lockfile = candidates.find { |c| File.exist?(c) }
end

unless lockfile && File.exist?(lockfile)
  puts "dep-completeness: SKIP (no Gemfile.lock found for #{project})"
  exit 0
end

gemfile = lockfile.sub(/Gemfile\.lock$/, "Gemfile")
ENV["BUNDLE_GEMFILE"] = File.expand_path(gemfile) if File.exist?(gemfile)

lf = Bundler::LockfileParser.new(File.read(lockfile))
errors = []

lf.specs.each do |spec|
  src = spec.source
  case src
  when Bundler::Source::Path
    next  # skip path sources
  when Bundler::Source::Git
    # Git gems handled by repo-level derivations
    next
  else
    dir = File.join(nix_dir, spec.name, spec.version.to_s)
    unless Dir.exist?(dir)
      # Check if it's a platform variant we skipped
      next if spec.platform.to_s != "ruby"
      errors << "#{spec.name} #{spec.version}: no derivation at #{dir}"
    end
  end
end

if errors.empty?
  puts "dep-completeness: OK (#{lf.specs.size} specs in lockfile)"
else
  errors.each { |e| puts "MISSING: #{e}" }
  puts "dep-completeness: #{errors.size} missing"
  exit 1
end
