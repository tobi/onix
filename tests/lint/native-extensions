#!/usr/bin/env ruby
# frozen_string_literal: true

# Lint: verify every gem marked with extensions has .so files in the nix store output.

require "open3"

project = ARGV[0] || "fizzy"

# Build the bundle path
out, status = Open3.capture2e("nix-build", "--no-out-link", "-E", <<~NIX)
  let pkgs = import <nixpkgs> {};
      ruby = pkgs.ruby_3_4;
      gems = import ./nix/#{project}.nix { inherit pkgs ruby; };
  in pkgs.symlinkJoin { name = "bundle"; paths = builtins.attrValues gems; }
NIX
abort "Failed to build bundle-path" unless status.success?
bundle = out.strip.lines.last.strip

ext_dir = Dir.glob("#{bundle}/ruby/*/extensions").first
gem_dir = Dir.glob("#{bundle}/ruby/*/gems").first

# Find gems that have ext/ dirs (should have been compiled)
errors = []
checked = 0
Dir.glob("#{gem_dir}/*/ext").each do |ext_path|
  gem_name_ver = File.basename(File.dirname(ext_path))
  # Check if .so exists in extensions/ or lib/
  has_so = false
  if ext_dir
    has_so = !Dir.glob("#{ext_dir}/**/#{gem_name_ver}/*.so").empty?
  end
  has_so ||= !Dir.glob("#{gem_dir}/#{gem_name_ver}/lib/**/*.so").empty?
  unless has_so
    errors << "#{gem_name_ver}: has ext/ but no .so found"
  end
  checked += 1
end

if errors.empty?
  puts "native-extensions: OK (#{checked} native gems checked)"
else
  errors.each { |e| puts "WARN: #{e}" }
  puts "native-extensions: #{errors.size} warnings out of #{checked}"
  # Don't fail â€” some gems have ext/ but don't produce .so (e.g. header-only)
end
