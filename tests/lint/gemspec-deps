#!/usr/bin/env ruby
# frozen_string_literal: true

# Lint: verify gemspec deps in the built bundle path look reasonable.

require "open3"

project = ARGV[0] || "fizzy"

out, status = Open3.capture2e("nix-build", "--no-out-link", "-E", <<~NIX)
  let pkgs = import <nixpkgs> {};
      ruby = pkgs.ruby_3_4;
      gems = import ./nix/#{project}.nix { inherit pkgs ruby; };
  in pkgs.symlinkJoin { name = "bundle"; paths = builtins.attrValues gems; }
NIX
abort "Failed to build bundle-path" unless status.success?
bundle = out.strip.lines.last.strip

spec_dir = Dir.glob("#{bundle}/ruby/*/specifications").first
abort "No specifications dir" unless spec_dir

specs = Dir.glob("#{spec_dir}/*.gemspec").map { |f| Gem::Specification.load(f) }.compact
errors = []

specs.each do |spec|
  # Basic sanity: name and version present
  errors << "#{spec.full_name}: empty name" if spec.name.to_s.empty?
  errors << "#{spec.full_name}: empty version" if spec.version.to_s.empty?
end

if errors.empty?
  puts "gemspec-deps: OK (#{specs.size} gemspecs checked)"
else
  errors.each { |e| puts "FAIL: #{e}" }
  puts "gemspec-deps: #{errors.size} errors"
  exit 1
end
