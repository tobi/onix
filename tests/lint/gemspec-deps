#!/usr/bin/env ruby
# frozen_string_literal: true

# Lint: verify every gemspec in the bundle path declares the same dependencies
# as gemset.json. Catches missing add_dependency lines.

require "json"
require "open3"

gems_dir = ARGV[0] || "out/gems"
gems_dir = File.expand_path(gems_dir)

bundle_out, status = Open3.capture2("nix-build", File.join(gems_dir, "bundle-path.nix"), "--no-out-link")
unless status.success?
  abort "Failed to build bundle-path"
end
bundle = bundle_out.strip.lines.last.strip

gemset = JSON.parse(File.read(File.join(gems_dir, "gemset.json")))
errors = []
checked = 0

gemset.each do |g|
  spec_path = File.join(bundle, "specifications", "#{g["name"]}-#{g["version"]}.gemspec")
  next unless File.exist?(spec_path)

  # Parse deps from the gemspec file
  content = File.read(spec_path)
  declared_deps = content.scan(/add_dependency\s+"([^"]+)"/).flatten.sort

  expected_deps = (g["deps"] || []).sort

  if declared_deps != expected_deps
    missing = expected_deps - declared_deps
    extra = declared_deps - expected_deps
    parts = []
    parts << "missing: #{missing.inspect}" if missing.any?
    parts << "extra: #{extra.inspect}" if extra.any?
    errors << "#{g["nix_attr"]}: #{parts.join(", ")}"
  end

  checked += 1
end

if errors.empty?
  puts "OK: #{checked} gemspecs have correct dependencies"
else
  puts "CHECKED: #{checked} gemspecs"
  errors.each { |e| $stderr.puts "FAIL: #{e}" }
  exit 1
end
