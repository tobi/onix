#!/usr/bin/env ruby
# frozen_string_literal: true

# scint-to-nix test-bundle
#
# Builds the bundle-path.nix and verifies gems are loadable.
# Optionally runs a command with GEM_PATH set.
#
# Usage:
#   test-bundle --gems-dir out/gems/
#   test-bundle --gems-dir out/gems/ -- ruby -e "require 'rack'; puts Rack::RELEASE"
#   test-bundle --gems-dir out/gems/ -- ruby bin/rails server

require "open3"

gems_dir = nil
cmd      = nil

i = 0
while i < ARGV.length
  if ARGV[i] == "--"
    cmd = ARGV[(i + 1)..]
    break
  end
  case ARGV[i]
  when "--gems-dir", "-g" then gems_dir = ARGV[i += 1]
  when "--help", "-h"
    $stderr.puts "Usage: test-bundle -g out/gems/ [-- command args...]"
    exit 0
  else abort "Unknown option: #{ARGV[i]}"
  end
  i += 1
end

abort "Missing --gems-dir" unless gems_dir
gems_dir = File.expand_path(gems_dir)

# Build the bundle path
$stdout.puts "Building bundle-path..."
out, status = Open3.capture2e("nix-build", File.join(gems_dir, "bundle-path.nix"), "--no-out-link")
unless status.success?
  $stderr.puts "Failed to build bundle-path:"
  $stderr.puts out
  exit 1
end

bundle_path = out.strip.lines.last.strip
$stdout.puts "Bundle path: #{bundle_path}"

# Find the nix ruby that gems were compiled against
nix_ruby_out, _ = Open3.capture2("nix-build", "<nixpkgs>", "-A", "ruby", "--no-out-link")
nix_ruby = File.join(nix_ruby_out.strip, "bin", "ruby")
$stdout.puts "Using ruby: #{nix_ruby}"

gem_count = Dir.children(File.join(bundle_path, "gems")).size
spec_count = Dir.children(File.join(bundle_path, "specifications")).size
$stdout.puts "Gems: #{gem_count}, Specifications: #{spec_count}"

if cmd && !cmd.empty?
  $stdout.puts "\nRunning: #{cmd.join(" ")}"
  $stdout.puts "GEM_PATH=#{bundle_path}"
  $stdout.puts "-" * 60

  env = {
    "GEM_PATH" => bundle_path,
    "GEM_HOME" => bundle_path,
  }
  exec(env, *cmd)
else
  # Quick smoke test: try to require a few gems
  $stdout.puts "\nSmoke test: loading gems..."

  test_gems = %w[rack json builder erubi zeitwerk]
  test_gems.each do |name|
    gem_dir = Dir.glob(File.join(bundle_path, "gems", "#{name}-*")).first
    if gem_dir
      out, status = Open3.capture2e(
        { "GEM_PATH" => bundle_path, "GEM_HOME" => bundle_path },
        nix_ruby, "-e", "require '#{name}'; puts '  OK #{name}'"
      )
      if status.success?
        $stdout.puts out.strip
      else
        $stdout.puts "  FAIL #{name}: #{out.strip.lines.first}"
      end
    end
  end

  $stdout.puts "\nTo run with these gems:"
  $stdout.puts "  export GEM_PATH=#{bundle_path}"
  $stdout.puts "  export GEM_HOME=#{bundle_path}"
end
